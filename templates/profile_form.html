{% extends "base.html" %}

{% block content %}
<div class="card">
    <h2>Step 1: Your Profile Information</h2>
    <p class="subtitle">Enter your complete profile information below. This will be used to match you with job opportunities.</p>
    
    {% if error %}
    <div class="error-message">{{ error }}</div>
    {% endif %}
</div>

<div class="card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
    <h3 style="color: white; margin-top: 0;">‚ú® Quick Start: Upload Your Resume</h3>
    <p style="margin-bottom: 1rem; opacity: 0.95;">Skip the manual entry! Upload your existing resume and we'll automatically extract your information.</p>
    
    <div style="background: rgba(255,255,255,0.15); border: 2px dashed rgba(255,255,255,0.4); border-radius: 8px; padding: 2rem; text-align: center; cursor: pointer; transition: all 0.3s;" 
         id="dropZone"
         onclick="document.getElementById('resumeFile').click()">
        <input type="file" id="resumeFile" accept=".pdf,.docx,.doc,.txt" style="display: none;" onchange="handleFileSelect(event)">
        <div id="uploadPrompt">
            <div style="font-size: 3rem; margin-bottom: 0.5rem;">üìÑ</div>
            <p style="font-size: 1.1rem; font-weight: 500; margin-bottom: 0.5rem;">Click to upload or drag & drop</p>
            <p style="font-size: 0.9rem; opacity: 0.9;">Supports PDF, DOCX, or TXT files</p>
        </div>
        <div id="uploadStatus" style="display: none;">
            <div style="font-size: 2rem; margin-bottom: 0.5rem;">‚è≥</div>
            <p style="font-size: 1.1rem; font-weight: 500;">Parsing your resume...</p>
            <p style="font-size: 0.9rem; opacity: 0.9;">This may take a few seconds</p>
        </div>
        <div id="uploadSuccess" style="display: none;">
            <div style="font-size: 2rem; margin-bottom: 0.5rem;">‚úÖ</div>
            <p style="font-size: 1.1rem; font-weight: 500;">Resume parsed successfully!</p>
            <p style="font-size: 0.9rem; opacity: 0.9;">Form fields have been auto-filled. Please review and edit as needed.</p>
        </div>
        <div id="uploadError" style="display: none;">
            <div style="font-size: 2rem; margin-bottom: 0.5rem;">‚ùå</div>
            <p style="font-size: 1.1rem; font-weight: 500;">Failed to parse resume</p>
            <p style="font-size: 0.9rem; opacity: 0.9;" id="errorMessage">Please fill out the form manually or try a different file.</p>
        </div>
    </div>
</div>

<form method="POST" action="/profile" id="profileForm">
    <div class="card">
        <h3>Personal Information</h3>
        <div class="form-group">
            <label for="name">Full Name *</label>
            <input type="text" id="name" name="name" required>
        </div>
        <div class="grid">
            <div class="form-group">
                <label for="email">Email</label>
                <input type="email" id="email" name="email">
            </div>
            <div class="form-group">
                <label for="phone">Phone</label>
                <input type="tel" id="phone" name="phone">
            </div>
        </div>
        <div class="grid">
            <div class="form-group">
                <label for="location">Location</label>
                <input type="text" id="location" name="location" placeholder="City, State">
            </div>
            <div class="form-group">
                <label for="linkedin">LinkedIn URL</label>
                <input type="url" id="linkedin" name="linkedin">
            </div>
        </div>
        <div class="form-group">
            <label for="summary">Professional Summary</label>
            <textarea id="summary" name="summary" rows="4" placeholder="Brief overview of your professional background..."></textarea>
        </div>
    </div>

    <div class="card">
        <h3>Education</h3>
        <div id="education-container">
            <div class="education-entry">
                <div class="grid">
                    <div class="form-group">
                        <label>Degree *</label>
                        <input type="text" name="education_degree" placeholder="e.g., Bachelor of Science">
                    </div>
                    <div class="form-group">
                        <label>Field of Study</label>
                        <input type="text" name="education_field" placeholder="e.g., Computer Science">
                    </div>
                </div>
                <div class="form-group">
                    <label>Institution</label>
                    <input type="text" name="education_institution" placeholder="University name">
                </div>
                <div class="grid">
                    <div class="form-group">
                        <label>Start Date</label>
                        <input type="text" name="education_start" placeholder="e.g., Sep 2018">
                    </div>
                    <div class="form-group">
                        <label>End Date</label>
                        <input type="text" name="education_end" placeholder="e.g., May 2022">
                    </div>
                    <div class="form-group">
                        <label>GPA (optional)</label>
                        <input type="text" name="education_gpa" placeholder="e.g., 3.8/4.0">
                    </div>
                </div>
                <div class="form-group">
                    <label>Achievements/Honors</label>
                    <textarea name="education_achievements" rows="2" placeholder="Dean's List, Scholarships, etc."></textarea>
                </div>
            </div>
        </div>
        <button type="button" onclick="addEducation()" class="btn-secondary">+ Add Another Education</button>
    </div>

    <div class="card">
        <h3>Work Experience</h3>
        <div id="experience-container">
            <div class="experience-entry">
                <div class="grid">
                    <div class="form-group">
                        <label>Job Title *</label>
                        <input type="text" name="experience_title" placeholder="e.g., Software Engineer">
                    </div>
                    <div class="form-group">
                        <label>Company</label>
                        <input type="text" name="experience_company" placeholder="Company name">
                    </div>
                </div>
                <div class="grid">
                    <div class="form-group">
                        <label>Location</label>
                        <input type="text" name="experience_location" placeholder="City, State">
                    </div>
                    <div class="form-group">
                        <label>Start Date</label>
                        <input type="text" name="experience_start" placeholder="e.g., Jan 2022">
                    </div>
                    <div class="form-group">
                        <label>End Date</label>
                        <input type="text" name="experience_end" placeholder="e.g., Present">
                    </div>
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea name="experience_description" rows="3" placeholder="Brief description of your role..."></textarea>
                </div>
                <div class="form-group">
                    <label>Key Achievements (one per line)</label>
                    <textarea name="experience_achievements" rows="4" placeholder="- Led team of 5 engineers&#10;- Increased performance by 40%&#10;- Deployed system to 1M+ users"></textarea>
                </div>
            </div>
        </div>
        <button type="button" onclick="addExperience()" class="btn-secondary">+ Add Another Experience</button>
    </div>

    <div class="card">
        <h3>Skills</h3>
        <div id="skills-container">
            <div class="skill-entry grid">
                <div class="form-group">
                    <label>Skill Name</label>
                    <input type="text" name="skill_name" placeholder="e.g., Python">
                </div>
                <div class="form-group">
                    <label>Category</label>
                    <input type="text" name="skill_category" placeholder="e.g., Programming Languages">
                </div>
                <div class="form-group">
                    <label>Proficiency</label>
                    <select name="skill_proficiency">
                        <option value="">Select...</option>
                        <option value="Expert">Expert</option>
                        <option value="Advanced">Advanced</option>
                        <option value="Intermediate">Intermediate</option>
                        <option value="Beginner">Beginner</option>
                    </select>
                </div>
            </div>
        </div>
        <button type="button" onclick="addSkill()" class="btn-secondary">+ Add Another Skill</button>
    </div>

    <div class="card">
        <h3>Projects (Optional)</h3>
        <div id="projects-container">
            <div class="project-entry">
                <div class="form-group">
                    <label>Project Name</label>
                    <input type="text" name="project_name" placeholder="e.g., E-commerce Platform">
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea name="project_description" rows="3" placeholder="What did you build?"></textarea>
                </div>
                <div class="form-group">
                    <label>Technologies Used</label>
                    <input type="text" name="project_technologies" placeholder="e.g., React, Node.js, MongoDB">
                </div>
                <div class="form-group">
                    <label>Project URL (optional)</label>
                    <input type="url" name="project_url" placeholder="https://...">
                </div>
                <div class="form-group">
                    <label>Key Achievements</label>
                    <textarea name="project_achievements" rows="2" placeholder="What was the impact?"></textarea>
                </div>
            </div>
        </div>
        <button type="button" onclick="addProject()" class="btn-secondary">+ Add Another Project</button>
    </div>

    <div class="card">
        <button type="submit" class="btn-primary">Next: Enter Role Information ‚Üí</button>
    </div>
</form>

<script>
const dropZone = document.getElementById('dropZone');

dropZone.addEventListener('dragover', (e) => {
    e.preventDefault();
    e.stopPropagation();
    dropZone.style.background = 'rgba(255,255,255,0.25)';
    dropZone.style.borderColor = 'rgba(255,255,255,0.8)';
});

dropZone.addEventListener('dragleave', (e) => {
    e.preventDefault();
    e.stopPropagation();
    dropZone.style.background = 'rgba(255,255,255,0.15)';
    dropZone.style.borderColor = 'rgba(255,255,255,0.4)';
});

dropZone.addEventListener('drop', (e) => {
    e.preventDefault();
    e.stopPropagation();
    dropZone.style.background = 'rgba(255,255,255,0.15)';
    dropZone.style.borderColor = 'rgba(255,255,255,0.4)';
    
    const files = e.dataTransfer.files;
    if (files.length > 0) {
        handleFileUpload(files[0]);
    }
});

function handleFileSelect(event) {
    const file = event.target.files[0];
    if (file) {
        handleFileUpload(file);
    }
}

async function handleFileUpload(file) {
    const validTypes = ['application/pdf', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document', 'application/msword', 'text/plain'];
    
    if (!validTypes.includes(file.type)) {
        showUploadState('error', 'Invalid file type. Please upload a PDF, DOCX, or TXT file.');
        return;
    }
    
    showUploadState('loading');
    
    const formData = new FormData();
    formData.append('resume', file);
    
    try {
        const response = await fetch('/parse_resume', {
            method: 'POST',
            body: formData
        });
        
        if (!response.ok) {
            throw new Error('Failed to parse resume');
        }
        
        const data = await response.json();
        populateFormWithParsedData(data);
        showUploadState('success');
    } catch (error) {
        console.error('Error parsing resume:', error);
        showUploadState('error', error.message);
    }
}

function showUploadState(state, message = '') {
    const prompt = document.getElementById('uploadPrompt');
    const loading = document.getElementById('uploadStatus');
    const success = document.getElementById('uploadSuccess');
    const error = document.getElementById('uploadError');
    
    prompt.style.display = 'none';
    loading.style.display = 'none';
    success.style.display = 'none';
    error.style.display = 'none';
    
    if (state === 'loading') {
        loading.style.display = 'block';
    } else if (state === 'success') {
        success.style.display = 'block';
        setTimeout(() => {
            showUploadState('prompt');
        }, 5000);
    } else if (state === 'error') {
        error.style.display = 'block';
        if (message) {
            document.getElementById('errorMessage').textContent = message;
        }
        setTimeout(() => {
            showUploadState('prompt');
        }, 5000);
    } else {
        prompt.style.display = 'block';
    }
}

function populateFormWithParsedData(data) {
    if (data.personal_info) {
        const pi = data.personal_info;
        if (pi.name) document.getElementById('name').value = pi.name;
        if (pi.email) document.getElementById('email').value = pi.email;
        if (pi.phone) document.getElementById('phone').value = pi.phone;
        if (pi.location) document.getElementById('location').value = pi.location;
        if (pi.linkedin) document.getElementById('linkedin').value = pi.linkedin;
        if (pi.summary) document.getElementById('summary').value = pi.summary;
    }
    
    if (data.education && data.education.length > 0) {
        const container = document.getElementById('education-container');
        container.innerHTML = '';
        
        data.education.forEach((edu, index) => {
            if (index > 0) addEducation();
            const entries = container.querySelectorAll('.education-entry');
            const entry = entries[entries.length - 1];
            
            const inputs = entry.querySelectorAll('input, textarea');
            const degreeInput = entry.querySelector('input[name="education_degree"]');
            const fieldInput = entry.querySelector('input[name="education_field"]');
            const institutionInput = entry.querySelector('input[name="education_institution"]');
            const startInput = entry.querySelector('input[name="education_start"]');
            const endInput = entry.querySelector('input[name="education_end"]');
            const gpaInput = entry.querySelector('input[name="education_gpa"]');
            const achievementsInput = entry.querySelector('textarea[name="education_achievements"]');
            
            if (edu.degree && degreeInput) degreeInput.value = edu.degree;
            if (edu.field_of_study && fieldInput) fieldInput.value = edu.field_of_study;
            if (edu.institution && institutionInput) institutionInput.value = edu.institution;
            if (edu.start_date && startInput) startInput.value = edu.start_date;
            if (edu.end_date && endInput) endInput.value = edu.end_date;
            if (edu.gpa && gpaInput) gpaInput.value = edu.gpa;
            if (edu.achievements && achievementsInput) achievementsInput.value = edu.achievements;
        });
    }
    
    if (data.experience && data.experience.length > 0) {
        const container = document.getElementById('experience-container');
        container.innerHTML = '';
        
        data.experience.forEach((exp, index) => {
            if (index > 0) addExperience();
            const entries = container.querySelectorAll('.experience-entry');
            const entry = entries[entries.length - 1];
            
            const titleInput = entry.querySelector('input[name="experience_title"]');
            const companyInput = entry.querySelector('input[name="experience_company"]');
            const locationInput = entry.querySelector('input[name="experience_location"]');
            const startInput = entry.querySelector('input[name="experience_start"]');
            const endInput = entry.querySelector('input[name="experience_end"]');
            const descInput = entry.querySelector('textarea[name="experience_description"]');
            const achievementsInput = entry.querySelector('textarea[name="experience_achievements"]');
            
            if (exp.title && titleInput) titleInput.value = exp.title;
            if (exp.company && companyInput) companyInput.value = exp.company;
            if (exp.location && locationInput) locationInput.value = exp.location;
            if (exp.start_date && startInput) startInput.value = exp.start_date;
            if (exp.end_date && endInput) endInput.value = exp.end_date;
            if (exp.description && descInput) descInput.value = exp.description;
            if (exp.achievements && achievementsInput) achievementsInput.value = exp.achievements;
        });
    }
    
    if (data.skills && data.skills.length > 0) {
        const container = document.getElementById('skills-container');
        container.innerHTML = '';
        
        data.skills.forEach((skill, index) => {
            if (index > 0) addSkill();
            const entries = container.querySelectorAll('.skill-entry');
            const entry = entries[entries.length - 1];
            
            const nameInput = entry.querySelector('input[name="skill_name"]');
            const categoryInput = entry.querySelector('input[name="skill_category"]');
            const proficiencySelect = entry.querySelector('select[name="skill_proficiency"]');
            
            if (skill.name && nameInput) nameInput.value = skill.name;
            if (skill.category && categoryInput) categoryInput.value = skill.category;
            if (skill.proficiency && proficiencySelect) proficiencySelect.value = skill.proficiency;
        });
    }
    
    if (data.projects && data.projects.length > 0) {
        const container = document.getElementById('projects-container');
        container.innerHTML = '';
        
        data.projects.forEach((project, index) => {
            if (index > 0) addProject();
            const entries = container.querySelectorAll('.project-entry');
            const entry = entries[entries.length - 1];
            
            const nameInput = entry.querySelector('input[name="project_name"]');
            const descInput = entry.querySelector('textarea[name="project_description"]');
            const techInput = entry.querySelector('input[name="project_technologies"]');
            const urlInput = entry.querySelector('input[name="project_url"]');
            const achievementsInput = entry.querySelector('textarea[name="project_achievements"]');
            
            if (project.name && nameInput) nameInput.value = project.name;
            if (project.description && descInput) descInput.value = project.description;
            if (project.technologies && techInput) techInput.value = project.technologies;
            if (project.url && urlInput) urlInput.value = project.url;
            if (project.achievements && achievementsInput) achievementsInput.value = project.achievements;
        });
    }
    
    window.scrollTo({ top: document.getElementById('profileForm').offsetTop, behavior: 'smooth' });
}

function addEducation() {
    const container = document.getElementById('education-container');
    const template = container.querySelector('.education-entry').cloneNode(true);
    template.querySelectorAll('input, textarea').forEach(el => el.value = '');
    container.appendChild(template);
}

function addExperience() {
    const container = document.getElementById('experience-container');
    const template = container.querySelector('.experience-entry').cloneNode(true);
    template.querySelectorAll('input, textarea').forEach(el => el.value = '');
    container.appendChild(template);
}

function addSkill() {
    const container = document.getElementById('skills-container');
    const template = container.querySelector('.skill-entry').cloneNode(true);
    template.querySelectorAll('input, select').forEach(el => el.value = '');
    container.appendChild(template);
}

function addProject() {
    const container = document.getElementById('projects-container');
    const template = container.querySelector('.project-entry').cloneNode(true);
    template.querySelectorAll('input, textarea').forEach(el => el.value = '');
    container.appendChild(template);
}
</script>
{% endblock %}
